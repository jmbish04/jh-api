name: Auto-Apply Gemini Suggestions

on:
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-apply:
    if: github.event.comment.user.login == 'gemini-code-assist[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Wait 10 seconds to batch Gemini comments
        run: sleep 10

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch and process comment
        id: process
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.comment.id }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "üîç Checking comment $COMMENT_ID from Gemini..."
          BODY=$(gh api /repos/$REPO/pulls/comments/$COMMENT_ID --jq '.body')
          FILE=$(gh api /repos/$REPO/pulls/comments/$COMMENT_ID --jq '.path')
          LINE=$(gh api /repos/$REPO/pulls/comments/$COMMENT_ID --jq '.line')

          echo "üìÑ File: $FILE (line $LINE)"
          echo "$BODY" | awk '/\`\`\`suggestion/,/\`\`\`/' | sed '/\`\`\`/d' > suggestion.patch

          if [ ! -s suggestion.patch ]; then
            echo "no_suggestion=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "no_suggestion=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Suggestion found:"
          cat suggestion.patch

          # Dry-run apply
          echo "üß™ Dry-run applying suggestion..."
          git apply --check suggestion.patch && echo "patch_valid=true" >> $GITHUB_OUTPUT || echo "patch_valid=false" >> $GITHUB_OUTPUT

      - name: Comment result on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          NO_SUGGESTION: ${{ steps.process.outputs.no_suggestion }}
          PATCH_VALID: ${{ steps.process.outputs.patch_valid }}
        run: |
          if [ "$NO_SUGGESTION" = "true" ]; then
            gh pr comment "$PR_NUMBER" --repo "$REPO" --body "‚úÖ Action ran successfully but no \`\`\`suggestion\`\`\` code blocks were detected in Gemini's comment."
            exit 0
          fi

          if [ "$PATCH_VALID" = "false" ]; then
            gh pr comment "$PR_NUMBER" --repo "$REPO" --body "‚ö†Ô∏è Gemini suggestion found but could not apply cleanly. Please review the patch manually from comment $COMMENT_ID."
            exit 0
          fi

          # Apply, commit, and push the patch
          echo "üöÄ Applying patch..."
          git apply suggestion.patch
          git add .
          git config user.name "auto-gemini-applier"
          git config user.email "bot@users.noreply.github.com"
          git commit -m "chore: apply Gemini suggestion from comment $COMMENT_ID"
          git push origin HEAD

          # Post confirmation with guidance
          cat <<EOF | gh pr comment "$PR_NUMBER" --repo "$REPO" --body-file -
          ‚úÖ **Gemini suggestion applied automatically!**

          Applied suggestion from comment $COMMENT_ID and pushed to this PR.

          **Next Steps:**
          - Review the auto-applied changes
          - If the suggestion was incorrect, you can revert this commit
          - To disable auto-apply for future suggestions, add \`[skip-auto-apply]\` to your PR description

          ---
          _Automated by auto-gemini-applier workflow_
          EOF
